{% extends 'dev/base.html' %}
{% load static %}
{% block content %}
<h3>スケジュール登録</h3>
<form method="post">
    {% csrf_token %}
    {% if form.errors %}
    <ul class="errorlist">
        {% for field in form %}
        {% for error in field.errors %}
        <li><strong>{{ field.label }}:</strong> {{ error }}</li>
        {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
        <li>{{ error }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    <!-- task_category と task の選択 -->
    {{ form.start_date.label_tag }}{{ form.start_date }}<br>
    {{ form.task_category }}<br>
    {{ form.task }}<br>
    {{ form.memo }}<br>
    <!-- frequency をボタンで選択 -->
    <div id="frequency-buttons">
        <label>繰り返し設定:</label><br>
        <button type="button" data-value="NONE">なし</button>
        <button type="button" data-value="DAILY">毎日</button>
        <button type="button" data-value="WEEKLY">毎週</button>
        <button type="button" data-value="MONTHLY">毎月</button>
        <button type="button" data-value="YEARLY">毎年</button>
    </div>
    <!-- Hidden フィールドで値を渡す -->
    {{ form.frequency }}
    <!-- frequency に応じて表示する項目 -->
    <div id="frequency-extra-fields">
        <div id="interval-field">
            <label>間隔: <input type="number" name="interval" id="id_interval" min="1"></label>
            <span class="field-help" id="interval-help"></span>
        </div>
        <div id="day-of-week-field">
            <label class="day-label" data-day="MO"><input type="radio" name="day_of_week" value="MO" id="day-MO">
                月曜日</label>
            <label class="day-label" data-day="TU"><input type="radio" name="day_of_week" value="TU" id="day-TU">
                火曜日</label>
            <label class="day-label" data-day="WE"><input type="radio" name="day_of_week" value="WE" id="day-WE">
                水曜日</label>
            <label class="day-label" data-day="TH"><input type="radio" name="day_of_week" value="TH" id="day-TH">
                木曜日</label>
            <label class="day-label" data-day="FI"><input type="radio" name="day_of_week" value="FI" id="day-FI">
                金曜日</label>
            <label class="day-label" data-day="SA"><input type="radio" name="day_of_week" value="SA" id="day-SA">
                土曜日</label>
            <label class="day-label" data-day="SU"><input type="radio" name="day_of_week" value="SU" id="day-SU">
                日曜日</label>
            <span class="field-help" id="day-of-week-help"></span>
        </div>
        <div id="nth-weekday-field">
            <!-- 毎月オプション -->
            <div class="monthly-options repeat-options">
                <label>
                    <input type="radio" name="monthly_option" value="by_date" checked>
                    <span id="monthly-date-info" class="field-help"></span>
                </label><br>

                <label>
                    <input type="radio" name="monthly_option" value="by_weekday">
                    <span id="monthly-weekday-info" class="field-help"></span>
                </label>

                <div id="monthly-nth-weekday-selects">
                    {{ form.nth_weekday }}<br>
                    <!-- <div id="monthly-day-of-week-select">
                        <label class="day-label" data-day="MO"><input type="radio" name="monthly_day_of_week"
                                value="MO"> </label>
                        <label class="day-label" data-day="TU"><input type="radio" name="monthly_day_of_week"
                                value="TU"> </label>
                        <label class="day-label" data-day="WE"><input type="radio" name="monthly_day_of_week"
                                value="WE"> </label>
                        <label class="day-label" data-day="TH"><input type="radio" name="monthly_day_of_week"
                                value="TH"> </label>
                        <label class="day-label" data-day="FR"><input type="radio" name="monthly_day_of_week"
                                value="FR"> </label>
                        <label class="day-label" data-day="SA"><input type="radio" name="monthly_day_of_week"
                                value="SA"> </label>
                        <label class="day-label" data-day="SU"><input type="radio" name="monthly_day_of_week"
                                value="SU"> </label>
                    </div> -->
                </div>
                <span class="field-help" id="nth-weekday-help"></span>
            </div>

            <!-- 毎年オプション -->
            <div class="yearly-options repeat-options">
                <label>
                    <input type="radio" name="yearly_option" value="by_date" checked>
                    <span id="yearly-date-info" class="field-help"></span>
                </label><br>

                <label>
                    <input type="radio" name="yearly_option" value="by_weekday">
                    <span id="yearly-weekday-info" class="field-help"></span>
                </label>

                <div id="yearly-nth-weekday-selects">
                    <br>
                    <!-- <div id="yearly-day-of-week-select">
                        <label class="day-label" data-day="MO"><input type="radio" name="yearly_day_of_week" value="MO">
                        </label>
                        <label class="day-label" data-day="TU"><input type="radio" name="yearly_day_of_week" value="TU">
                        </label>
                        <label class="day-label" data-day="WE"><input type="radio" name="yearly_day_of_week" value="WE">
                        </label>
                        <label class="day-label" data-day="TH"><input type="radio" name="yearly_day_of_week" value="TH">
                        </label>
                        <label class="day-label" data-day="FI"><input type="radio" name="yearly_day_of_week" value="FI">
                        </label>
                        <label class="day-label" data-day="SA"><input type="radio" name="yearly_day_of_week" value="SA">
                        </label>
                        <label class="day-label" data-day="SU"><input type="radio" name="yearly_day_of_week" value="SU">
                        </label>
                    </div> -->
                </div>
            </div>

        </div>
    </div>
    <br>
    <button type="submit">登録</button>
</form>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Ajaxでカテゴリーに応じたタスクを表示処理 -->
<script>
    $("#id_task_category").change(function () {
        const url = "{% url 'apps:ajax_load_tasks' %}";
        const categoryId = $(this).val();

        $.ajax({
            url: url,
            data: {
                'task_category': categoryId
            },
            success: function (data) {
                const $taskSelect = $("#id_task");
                $taskSelect.empty();
                $.each(data, function (index, task) {
                    $taskSelect.append(`<option value="${task.id}">${task.task_name}</option>`);
                });
            }
        });
    });
</script>

<!-- frequency ボタン切り替え処理 -->
<script>
    $(document).ready(function () {
        // 初期は全フィールド非表示
        $("#interval-field, #day-of-week-field, #nth-weekday-field").hide();

        // 曜日コードマップ（日曜=0〜土曜=6 → Djangoの曜日コード）
        const jsDayToDjangoCode = ["SU", "MO", "TU", "WE", "TH", "FI", "SA"];

        // 指定曜日だけ表示しチェック。その他非表示
        function showOnlySelectedWeekday(selectedDay) {
            $(".day-label").each(function () {
                if ($(this).data("day") === selectedDay) {
                    $(this).show();
                    $(this).find("input[type=radio]").prop("checked", true);
                } else {
                    $(this).hide();
                    $(this).find("input[type=radio]").prop("checked", false);
                }
            });
        }

        // 開始日から曜日セット(毎週選択時使用)
        function setDayOfWeekFromStartDate() {
            const startDateStr = $("#id_start_date").val();
            if (!startDateStr) return;

            const dateObj = new Date(startDateStr);
            if (isNaN(dateObj)) return;

            const jsDay = dateObj.getDay();
            const djangoDay = jsDayToDjangoCode[jsDay];

            if ($("#id_frequency").val() === "WEEKLY") {
                showOnlySelectedWeekday(djangoDay);
            } else {
                // 週以外は全部表示してチェックなし
                $(".day-label").show();
                $("input[name='day_of_week']").prop("checked", false);
            }
        }

        // 第何週何曜日取得の関数(毎月選択時に使用)
        function getOrdinalWeekdayInfo(dateObj) {
            const jsDay = dateObj.getDay(); // 0〜6
            const jsDayToDjangoCode = ["SU", "MO", "TU", "WE", "TH", "FR", "SA"];
            const djangoDay = jsDayToDjangoCode[jsDay];

            const nth = Math.floor((dateObj.getDate() - 1) / 7);
            const weekNames = ["第1", "第2", "第3", "第4", "第5"];
            const dayNames = ["日", "月", "火", "水", "木", "金", "土"];

            return {
                nth,
                djangoDay,
                label: `${weekNames[nth]}${dayNames[jsDay]}曜日`
            };
        }
        // MonthlyOptions選択時（毎月選択時に使用）
        function updateMonthlyOptionsFromStartDate() {
            const dateStr = $("#id_start_date").val();
            if (!dateStr) return;

            const dateObj = new Date(dateStr);
            if (isNaN(dateObj)) return;

            const y = dateObj.getFullYear(), m = dateObj.getMonth() + 1, d = dateObj.getDate();
            $("#monthly-date-info").text(`${d}日`);

            const info = getOrdinalWeekdayInfo(dateObj);
            $("#monthly-weekday-info").text(`${info.label}`);

            // デフォルトでフォームに値をセット（初期表示）
            $("#id_nth_weekday").val(info.nth + 1);
            $("input[name='day_of_week']").prop("checked", false);
            $(`input[name='day_of_week'][value='${info.djangoDay}']`).prop("checked", true);
        }
        // YearlyOptions選択時（毎年選択時に使用）
        function updateYearlyOptionsFromStartDate() {
            const dateStr = $("#id_start_date").val();
            if (!dateStr) return;

            const dateObj = new Date(dateStr);
            if (isNaN(dateObj)) return;

            const y = dateObj.getFullYear(), m = dateObj.getMonth() + 1, d = dateObj.getDate();
            $("#yearly-date-info").text(`${m}月${d}日`);

            const jsDay = dateObj.getDay(); // 0〜6
            const jsDayToDjangoCode = ["SU", "MO", "TU", "WE", "TH", "FR", "SA"];
            const djangoDay = jsDayToDjangoCode[jsDay];
            const nth = Math.floor((dateObj.getDate() - 1) / 7);
            const weekNames = ["第1", "第2", "第3", "第4", "第5"];
            const dayNames = ["日", "月", "火", "水", "木", "金", "土"];

            $("#yearly-weekday-info").text(`${m}月${weekNames[nth]}${dayNames[jsDay]}曜日`);

            $("#id_nth_weekday").val(nth + 1);
            $("input[name='day_of_week']").prop("checked", false);
            $(`input[name='day_of_week'][value='${djangoDay}']`).prop("checked", true);
        }

        // MONTHLYオプション切替
        $("input[name='monthly_option']").change(function () {
            const option = $(this).val();

            if (option === "by_weekday") {
                $("#monthly-nth-weekday-selects").hide();
                // 選択された曜日を保持（すでに updatemonthlyOptionsFromStartDate() でセット済み）
            } else if (option === "by_date") {
                $("#monthly-nth-weekday-selects").hide();
                //  by_date 選択時は day_of_week を空にする
                $("#id_day_of_week").val("");
            }
        });

        // YEARLYオプション切替
        $("input[name='yearly_option']").change(function () {
            const option = $(this).val();

            if (option === "by_weekday") {
                $("#yearly-nth-weekday-selects").hide();
                // 選択された曜日を保持（すでに updateYearlyOptionsFromStartDate() でセット済み）
            } else if (option === "by_date") {
                $("#yearly-nth-weekday-selects").hide();
                //  by_date 選択時は day_of_week を空にする
                $("#id_day_of_week").val("");
            }
        });


        // frequencyボタンクリック
        $("#frequency-buttons button").click(function () {
            const value = $(this).data("value");
            $("#id_frequency").val(value);

            $("#frequency-buttons button").removeClass("selected");
            $(this).addClass("selected");

            //  interval の初期値を1にセット（NONE以外の時）
            if (value !== "NONE") {
                $("#id_interval").val(1);
            } else {
                $("#id_interval").val("");  // NONE の時は空にする
            }

            $("#interval-field, #day-of-week-field, #nth-weekday-field").hide();
            $(".monthly-options, .yearly-options").hide();
            $(".field-help").text("");
            $(".day-label").show();
            $("input[name='day_of_week']").prop("checked", false);

            if (value === "DAILY") {
                $("#interval-field").show();
                $("#interval-help").text("日ごと");
            } else if (value === "WEEKLY") {
                $("#interval-field, #day-of-week-field").show();
                $("#interval-help").text("週間ごと");
                $("#day-of-week-help").text("");
                setDayOfWeekFromStartDate();
            } else if (value === "MONTHLY") {
                $("#interval-field, #nth-weekday-field").show();
                $(".monthly-options").show();
                $("#interval-help").text("か月ごと");
                $("input[name='monthly_day_of_week']").prop("checked", true).hide();
                updateMonthlyOptionsFromStartDate();
                $("input[name='monthly_option'][value='by_date']").prop("checked", true);
                $("#monthly-nth-weekday-selects").hide();
            } else if (value === "YEARLY") {
                $("#interval-field, #nth-weekday-field").show();
                $("#interval-help").text("年ごと");
                $(".yearly-options").show();
                $("input[name='yearly_day_of_week']").prop("checked", true);
                updateYearlyOptionsFromStartDate();
            } else if (value === "NONE") {
                $("#interval-field, #day-of-week-field, #nth-weekday-field").hide();
            }
        });

        // 開始日変更時
        $("#id_start_date").change(function () {
            const freq = $("#id_frequency").val();
            if (freq === "WEEKLY") {
                $("#frequency-buttons button[data-value='WEEKLY']").addClass("selected");
                $("#interval-field, #day-of-week-field").show();
                setDayOfWeekFromStartDate();
            } else if (freq === "MONTHLY") {
                $("#frequency-buttons button[data-value='MONTHLY']").addClass("selected");
                $("#interval-field, #nth-weekday-field").show();
                $(".monthly-options").show();
                updateMonthlyOptionsFromStartDate();
                if ($("input[name='monthly_option']:checked").val() === "by_weekday") {
                    $("#monthly-nth-weekday-selects").show();
                }
            } else if (freq === "YEARLY") {
                $("#frequency-buttons button[data-value='YEARLY']").addClass("selected");
                $("#interval-field, #nth-weekday-field").show();
                $(".yearly-options").show();
                updateYearlyOptionsFromStartDate();
            }
        });

        // 初期表示時に frequency による設定を反映
        const initialFreq = $("#id_frequency").val();
        if (initialFreq) {
            $(`#frequency-buttons button[data-value='${initialFreq}']`).trigger('click');
        }
    });
</script>

<!-- ボタンスタイル -->
<style>
    #frequency-buttons button.selected {
        background-color: #4CAF50;
        color: white;
    }
</style>
{% endblock %}