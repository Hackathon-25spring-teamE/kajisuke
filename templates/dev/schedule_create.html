{% extends 'dev/base.html' %}
{% load static %}
{% block content %}
<h3>スケジュール登録</h3>
<form method="post">
    {% csrf_token %}
    {% if form.errors %}
    <ul class="errorlist">
        {% for field in form %}
        {% for error in field.errors %}
        <li><strong>{{ field.label }}:</strong> {{ error }}</li>
        {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
        <li>{{ error }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    <!-- task_category と task の選択 -->
    {{ form.start_date.label_tag }} {{ form.start_date }}<br>
    {{ form.task_category.label_tag }} {{ form.task_category }}<br>
    {{ form.task.label_tag }} {{ form.task }}<br>
    {{ form.memo.label_tag }} {{ form.memo }}<br>
    <!-- frequency をボタンで選択 -->
    <div id="frequency-buttons">
        <label>繰り返し設定:</label><br>
        <button type="button" data-value="NONE">なし</button>
        <button type="button" data-value="DAILY">毎日</button>
        <button type="button" data-value="WEEKLY">毎週</button>
        <button type="button" data-value="MONTHLY">毎月</button>
        <button type="button" data-value="YEARLY">毎年</button>
    </div>
    <!-- Hidden フィールドで値を渡す -->
    {{ form.frequency }}
    <!-- frequency に応じて表示する項目 -->
    <div id="frequency-extra-fields">
        <div id="interval-field">
            {{ form.interval.label_tag }} {{ form.interval }}
            <span class="field-help" id="interval-help"></span>
        </div>
        <div id="day-of-week-field">
            <label class="day-label" data-day="MO"><input type="radio" name="day_of_week" value="MO" id="day-MO"> 月曜日</label>
            <label class="day-label" data-day="TU"><input type="radio" name="day_of_week" value="TU" id="day-TU"> 火曜日</label>
            <label class="day-label" data-day="WE"><input type="radio" name="day_of_week" value="WE" id="day-WE"> 水曜日</label>
            <label class="day-label" data-day="TH"><input type="radio" name="day_of_week" value="TH" id="day-TH"> 木曜日</label>
            <label class="day-label" data-day="FI"><input type="radio" name="day_of_week" value="FI" id="day-FI"> 金曜日</label>
            <label class="day-label" data-day="SA"><input type="radio" name="day_of_week" value="SA" id="day-SA"> 土曜日</label>
            <label class="day-label" data-day="SU"><input type="radio" name="day_of_week" value="SU" id="day-SU"> 日曜日</label>
            <span class="field-help" id="day-of-week-help"></span>
        </div>
        <div id="nth-weekday-field">
            {{ form.nth_weekday.label_tag }} {{ form.nth_weekday }}
            <span class="field-help" id="nth-weekday-help"></span>
        </div>
    </div>
    <br>
    <button type="submit">登録</button>
</form>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Ajaxでカテゴリーに応じたタスクを表示処理 -->
<script>
    $("#id_task_category").change(function () {
        const url = "{% url 'apps:ajax_load_tasks' %}";
        const categoryId = $(this).val();

        $.ajax({
            url: url,
            data: {
                'task_category': categoryId
            },
            success: function (data) {
                const $taskSelect = $("#id_task");
                $taskSelect.empty();
                $.each(data, function (index, task) {
                    $taskSelect.append(`<option value="${task.id}">${task.task_name}</option>`);
                });
            }
        });
    });
</script>

<!-- frequency ボタン切り替え処理 -->
<script>
    $(document).ready(function () {
        // 初期は全フィールド非表示
        $("#interval-field, #day-of-week-field, #nth-weekday-field, #day-of-month-field").hide();

        // 曜日コードマップ（日曜=0〜土曜=6 → Djangoの曜日コード）
        const jsDayToDjangoCode = ["SU", "MO", "TU", "WE", "TH", "FI", "SA"];

        // 指定曜日だけ表示しチェック。その他非表示
        function showOnlySelectedWeekday(selectedDay) {
            $(".day-label").each(function () {
                if ($(this).data("day") === selectedDay) {
                    $(this).show();
                    $(this).find("input[type=radio]").prop("checked", true);
                } else {
                    $(this).hide();
                    $(this).find("input[type=radio]").prop("checked", false);
                }
            });
        }

        // 開始日から曜日セット
        function setDayOfWeekFromStartDate() {
            const startDateStr = $("#id_start_date").val();
            if (!startDateStr) return;

            const dateObj = new Date(startDateStr);
            if (isNaN(dateObj)) return;

            const jsDay = dateObj.getDay();
            const djangoDay = jsDayToDjangoCode[jsDay];

            if ($("#id_frequency").val() === "WEEKLY") {
                showOnlySelectedWeekday(djangoDay);
            } else {
                // 週以外は全部表示してチェックなし
                $(".day-label").show();
                $("input[name='day_of_week']").prop("checked", false);
            }
        }

        // frequencyボタンクリック
        $("#frequency-buttons button").click(function () {
            const value = $(this).data("value");
            $("#id_frequency").val(value);

            $("#frequency-buttons button").removeClass("selected");
            $(this).addClass("selected");

            $("#interval-field, #day-of-week-field, #nth-weekday-field").hide();
            $(".field-help").text("");

            if (value === "DAILY") {
                $("#interval-field").show();
                $("#interval-help").text("日ごと");
                $(".day-label").show();
                $("input[name='day_of_week']").prop("checked", false);
            } else if (value === "WEEKLY") {
                $("#interval-field, #day-of-week-field").show();
                $("#interval-help").text("週間ごと");
                $("#day-of-week-help").text("繰り返す曜日");
                setDayOfWeekFromStartDate();
            } else if (value === "MONTHLY") {
                $("#interval-field, #nth-weekday-field").show();
                $("#interval-help").text("か月ごと");
                $("#nth-weekday-help").text("第何週の何曜日");
                $(".day-label").show();
                $("input[name='day_of_week']").prop("checked", false);
            } else if (value === "YEARLY") {
                $("#interval-field").show();
                $("#interval-help").text("年ごと");
                $(".day-label").show();
                $("input[name='day_of_week']").prop("checked", false);
            } else {
                $(".day-label").show();
                $("input[name='day_of_week']").prop("checked", false);
            }
        });

        // ページ読み込み時
        if ($("#id_frequency").val() === "WEEKLY") {
            $("#frequency-buttons button[data-value='WEEKLY']").addClass("selected");
            $("#interval-field, #day-of-week-field").show();
            setDayOfWeekFromStartDate();
        }

        // 開始日変更時
        $("#id_start_date").change(function () {
            if ($("#id_frequency").val() === "WEEKLY") {
                setDayOfWeekFromStartDate();
            }
        });
    });
</script>

<!-- ボタンスタイル -->
<style>
    #frequency-buttons button.selected {
        background-color: #4CAF50;
        color: white;
    }
</style>
{% endblock %}
